name: Flutter Build and Deploy Web

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  FLUTTER_VERSION: ${{ secrets.FLUTTER_VERSION }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GH_PAGES_DEPLOY_TOKEN: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
  WEB_URL: ${{ secrets.WEB_URL }}
  # Cho phÃ©p dÃ¹ng trá»±c tiáº¿p trong shell náº¿u cáº§n (khÃ´ng in ra logs!)
  BASE_URL: ${{ secrets.BASE_URL }}
  REGISTER_ID: ${{ secrets.REGISTER_ID }}

jobs:
  notify-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Get Commit Info
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty="%an")
          COMMIT_DATE=$(git log -1 --pretty="%cd" --date=iso)
          MESSAGE="ğŸ›  *New Build Triggered*%0A"
          MESSAGE+="%0A"
          MESSAGE+="ğŸ‘¤ *Author:* \`$COMMIT_AUTHOR\`%0A"
          MESSAGE+="ğŸ“… *Date:* \`$COMMIT_DATE\`%0A"
          MESSAGE+="ğŸ”¢ *Commit:* \`$COMMIT_HASH\`%0A"
          MESSAGE+="ğŸ“ *Message:* \`$COMMIT_MESSAGE\`%0A"
          curl -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               -d "parse_mode=MarkdownV2"

  build-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        run: flutter pub get

      # ====== Táº O FILE env/.env.dev (Ä‘Ãºng path Envied Ä‘ang dÃ¹ng) ======
      - name: Create env/.env.dev file
        run: |
          mkdir -p env
          cat > env/.env.dev << 'EOF'
          BASE_URL=${{ secrets.BASE_URL }}
          REGISTER_ID=${{ secrets.REGISTER_ID }}
          EOF

      # (Tuá»³ chá»n) Kiá»ƒm tra file tá»“n táº¡i mÃ  khÃ´ng lá»™ dá»¯ liá»‡u
      - name: Verify env/.env.dev existence (no secret leak)
        run: |
          test -f env/.env.dev && echo "env/.env.dev exists âœ…"
          wc -c env/.env.dev

      # ====== SINH CODE *.g.dart TRÆ¯á»šC KHI BUILD WEB ======
      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Web with base href set to root
        run: flutter build web --release --base-href="/shopping_app/" -t lib/main_preview.dart

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
          publish_dir: build/web
          publish_branch: gh-pages
          force_orphan: true

      - name: Send Web Build URL to Telegram
        run: |
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
          # Escape URL cho MarkdownV2
          ESCAPED_WEB_URL=$(echo "${{ env.WEB_URL }}" | sed 's/\./\\./g' | sed 's/\//\\\//g')
          MESSAGE="ğŸš€ *Web Build Completed*%0A"
          MESSAGE+="ğŸ“… *Date:* \`$TIMESTAMP\`%0A"
          MESSAGE+="ğŸŒ *URL:* \[Click here\]\($ESCAPED_WEB_URL\)"
          curl -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               --data-urlencode "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
               --data-urlencode "text=$MESSAGE" \
               --data-urlencode "parse_mode=MarkdownV2"
